#!/bin/bash
# wine-iso: Mount/unmount ISO files as Wine CD-ROM drives

set -e

MOUNT_BASE="$HOME/mnt/wine-iso"
# All wine prefixes used by wine-launcher
WINE_PREFIXES=(
    "$HOME/.wine32"
    "$HOME/.wine64"
    "$HOME/.wine-hangover"
)

usage() {
    cat << EOF
Usage: wine-iso mount <drive> <iso-path>    Mount ISO to Wine drive
       wine-iso unmount <drive>             Unmount drive
       wine-iso swap <drive> <iso-path>     Swap disc - lazy unmount then mount
       wine-iso list                        List mounted ISO drives
       wine-iso unmount-all                 Unmount all ISO drives

Examples:
    wine-iso mount d "/path/to/game.iso"
    wine-iso swap d "/path/to/disc2.iso"
    wine-iso unmount d
    wine-iso list

Drive letters are case-insensitive.
EOF
    exit 1
}

ensure_dirs() {
    mkdir -p "$MOUNT_BASE"
    for prefix in "${WINE_PREFIXES[@]}"; do
        mkdir -p "$prefix/dosdevices"
    done
}

# Create symlink in all wine prefixes
link_drive() {
    local drive="$1"
    local target="$2"
    for prefix in "${WINE_PREFIXES[@]}"; do
        rm -f "$prefix/dosdevices/${drive}:"
        ln -s "$target" "$prefix/dosdevices/${drive}:"
    done
}

# Remove symlink from all wine prefixes
unlink_drive() {
    local drive="$1"
    for prefix in "${WINE_PREFIXES[@]}"; do
        rm -f "$prefix/dosdevices/${drive}:"
    done
}

to_lower() {
    echo "$1" | tr "[:upper:]" "[:lower:]"
}

mount_iso() {
    local drive=$(to_lower "$1")
    local iso_path="$2"
    local mount_point="$MOUNT_BASE/$drive"

    if [[ ! -f "$iso_path" ]]; then
        echo "Error: ISO file not found: $iso_path"
        exit 1
    fi

    if mountpoint -q "$mount_point" 2>/dev/null; then
        echo "Error: Drive $drive: is already mounted"
        echo "Use: wine-iso swap $drive <iso>"
        exit 1
    fi

    ensure_dirs
    mkdir -p "$mount_point"

    echo "Mounting: $iso_path"
    fuseiso -o ro,umask=0222 "$iso_path" "$mount_point"

    link_drive "$drive" "$mount_point"

    echo "Mounted as ${drive^^}: in Wine (all prefixes)"
    echo "Contents:"
    ls "$mount_point" | head -10
    local count=$(ls "$mount_point" | wc -l)
    [[ $count -gt 10 ]] && echo "... and $((count - 10)) more files"
}

swap_iso() {
    local drive=$(to_lower "$1")
    local iso_path="$2"
    local mount_point="$MOUNT_BASE/$drive"

    if [[ ! -f "$iso_path" ]]; then
        echo "Error: ISO file not found: $iso_path"
        exit 1
    fi

    ensure_dirs

    if mountpoint -q "$mount_point" 2>/dev/null; then
        echo "Lazy unmounting current disc..."
        fusermount -uz "$mount_point" 2>/dev/null || true
        sleep 0.5
    fi

    rmdir "$mount_point" 2>/dev/null || true
    mkdir -p "$mount_point"

    echo "Mounting: $iso_path"
    fuseiso -o ro,umask=0222 "$iso_path" "$mount_point"

    link_drive "$drive" "$mount_point"

    echo "Swapped ${drive^^}: in Wine (all prefixes)"
    echo "Contents:"
    ls "$mount_point" | head -10
    local count=$(ls "$mount_point" | wc -l)
    [[ $count -gt 10 ]] && echo "... and $((count - 10)) more files"
}

unmount_iso() {
    local drive=$(to_lower "$1")
    local mount_point="$MOUNT_BASE/$drive"

    if ! mountpoint -q "$mount_point" 2>/dev/null; then
        echo "Drive $drive: is not mounted"
        unlink_drive "$drive"
        rmdir "$mount_point" 2>/dev/null || true
        exit 0
    fi

    echo "Unmounting ${drive^^}:..."
    if ! fusermount -u "$mount_point" 2>/dev/null; then
        echo "Device busy - use: wine-iso swap $drive <new-iso>"
        exit 1
    fi
    unlink_drive "$drive"
    rmdir "$mount_point" 2>/dev/null || true

    echo "Done"
}

list_mounted() {
    echo "Mounted ISO drives:"
    echo
    local found=0
    for mount_point in "$MOUNT_BASE"/*; do
        [[ -d "$mount_point" ]] || continue
        if mountpoint -q "$mount_point" 2>/dev/null; then
            local drive=$(basename "$mount_point")
            local source=$(findmnt -n -o SOURCE "$mount_point" 2>/dev/null || echo "unknown")
            printf "  %s:  ->  %s\n" "${drive^^}" "$source"
            found=1
        fi
    done
    [[ $found -eq 0 ]] && echo "  (none)"
}

unmount_all() {
    echo "Unmounting all ISO drives..."
    local found=0
    for mount_point in "$MOUNT_BASE"/*; do
        [[ -d "$mount_point" ]] || continue
        if mountpoint -q "$mount_point" 2>/dev/null; then
            local drive=$(basename "$mount_point")
            unmount_iso "$drive"
            found=1
        fi
    done
    [[ $found -eq 0 ]] && echo "No drives to unmount"
}

case "${1:-}" in
    mount)
        [[ -z "${2:-}" || -z "${3:-}" ]] && usage
        mount_iso "$2" "$3"
        ;;
    swap)
        [[ -z "${2:-}" || -z "${3:-}" ]] && usage
        swap_iso "$2" "$3"
        ;;
    unmount|umount)
        [[ -z "${2:-}" ]] && usage
        unmount_iso "$2"
        ;;
    list|ls)
        list_mounted
        ;;
    unmount-all|umount-all)
        unmount_all
        ;;
    *)
        usage
        ;;
esac
